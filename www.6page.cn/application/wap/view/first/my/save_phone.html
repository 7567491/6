
{extend name="public/container"}
{block name="title"}{if $user_phone}更换手机号码{else}绑定手机号码{/if}-{$Auth_site_name}{/block}
{block name='head_top'}
<style>
    body{background-color: #f2f2f2}
    .bind-tips{
        text-align: center;
        padding: 10px;
        color: #333;
        font-size: 14px;
    }
</style>
{/block}
{block name="content"}
<div id="app" v-cloak="">
    <div class="replace-phone">
        {empty name='user_phone'}
        <div class="bind-tips">为了获得更好的用户体验，请先绑定手机号码</div>
        {/empty}
        <ul class="list">
            <li class="item"><input type="text" :placeholder="place_msg" v-model="phone" :disabled="disabled"></li>
            <li class="item itemCode acea-row row-between-wrapper">
                <input type="text" v-model="code_num" placeholder="请输入验证码">
                <button id="captcha-btn" class="code" :disabled="active" :class="active == true?'on':''" @click="code">{{timetext}}</button>
            </li>
        </ul>
        <div class="bnt" v-text="but_name" @click="goNext">下一步</div>
    </div>
    <div id="slide-captcha" class="slide-captcha"></div>
    <!--完成-->
{include file="public/store_menu"}
</div>
{/block}
{block name='foot'}
<script>
    var phone='{$user_phone}';
    var user_type = '{$userInfo.user_type}';
    require(['vue','helper', 'layer', 'store','reg-verify', '{$Think.const.IMG_DOMAIN}{__WAP_PATH}/js/quick.js'],function(Vue,$h,layer,app,$reg) {
        new Vue({
            el: '#app',
            data: {
                phone:phone || '',
                code_num:'',
                place_msg:phone ? '请输入原的手机号' : '请输入手机号码',
                active:false,
                timetext:'获取验证码',
                but_name:phone ? '下一步':'确认绑定',
                run:null,
                type:0,
                disabled: phone ? true : false,
                // yz：验证、bd：绑定
                step: phone ? 'yz' : 'bd'
            },
            mounted: function(){
                if (typeof slide_captcha === 'undefined' || !slide_captcha) {
                    return
                }
                var vm = this;
                $('#slide-captcha').slideVerify({
                    baseUrl: slide_captcha_api,  //服务器请求地址;
                    mode: 'pop',     //展示模式
                    containerId: 'captcha-btn',//pop模式 必填 被点击之后出现行为验证码的元素id
                    imgSize : {       //图片的大小对象,有默认值{ width: '310px',height: '155px'},可省略
                        width: '300px',
                        height: '150px',
                    },
                    barSize:{          //下方滑块的大小对象,有默认值{ width: '310px',height: '50px'},可省略
                        width: '200px',
                        height: '30px',
                    },
                    beforeCheck:function(){
                        if (!vm.phone) {
                            $h.pushMsgOnce('请输入手机号码')
                            return false;
                        }
                        if (!/^1[3456789]\d{9}$/.test(vm.phone)) {
                            $h.pushMsgOnce('请输入正确的手机号码')
                            return false;
                        }
                        return true
                    },
                    ready : function() {},  //加载完毕的回调
                    success : function(params) { //成功的回调
                        vm.slideCode(params);
                    },
                    error : function() {}        //失败的回调
                });
            },
            methods:{
                slideCode: function (params) {
                    var vm = this;
                    vm.active = true;
                    var n = 60;
                    app.basePost($h.U({
                        c: 'auth_api',
                        a: 'code'
                    }),{
                        phone: vm.phone,
                        token: params.data.token,
                        pointJson: params.data.pointJson,
                        captchaType: 'blockPuzzle'
                    }, function (res) {
                        var data = res.data.data;
                        if (data.Message == 'OK' || data.Code == 'OK') {
                            vm.run = setInterval(function () {
                                n--;
                                if (n < 0) {
                                    clearInterval(vm.run);
                                    vm.run = null
                                }
                                vm.timetext = "剩余 " + n + "s";
                                if (vm.timetext < "剩余 " + 0 + "s") {
                                    vm.active = false;
                                    vm.timetext = "重发";
                                }
                            }, 1000);
                        } else {
                            $h.pushMsgOnce(data.Message);
                            vm.active = false;
                        }
                    })
                },
                goNext:function(){
                    var that=this;
                    if(phone){
                        // 验证旧手机号
                        app.baseGet($h.U({c:'my',a:'validate_code',q:{phone:this.phone,code:this.code_num}}),function (res) {
                            $h.pushMsgOnce(res.data.msg,function () {
                                that.phone='';
                                that.code_num='';
                                that.but_name='确认绑定';
                                that.place_msg='请输入新手机号码';
                                that.active=false;
                                that.type=1;
                                that.disabled = false;
                                that.step = 'bd'
                                phone='';
                                if(that.run) clearInterval(that.run);
                                that.timetext='获取验证码';
                                document.title='绑定手机号码';
                            });
                        });
                    }else{
                        // 绑定新手机号
                        app.baseGet($h.U({
                            c:'my',
                            a:'save_phone',
                            q:{
                                phone:this.phone,
                                code:this.code_num,
                                type:this.type
                            }
                        }),function (res) {
                            $h.pushMsgOnce(res.data.msg)
                            setTimeout(function () {
                                window.location.href=$h.U({s: true, c:'my',a:'index'});
                            }, 1000)
                        });
                    }
                },
                goCode: function () {
                    var that = this;
                    that.active = true;
                    var n = 60;
                    app.basePost($h.U({c:'auth_api',a:'code'}), {phone:that.phone},function (res){
                        var data=res.data.data;
                        if(data.Message=='OK' || data.Code=='OK'){
                            that.run=setInterval(function(){
                                n--;
                                if(n<0){
                                    clearInterval(that.run);
                                    that.run=null
                                }
                                that.timetext = "剩余 "+n+"s";
                                if(that.timetext<"剩余 "+0+"s"){
                                    that.active = false;
                                    that.timetext = "重发";
                                }
                            },1000);
                        }else{
                            $h.pushMsgOnce(data.Message);
                            that.active =false;
                        }
                    },function (res) {
                        that.active =false;
                    });
                },
                code:function () {
                    if (typeof slide_captcha !== 'undefined' && slide_captcha) {
                        return
                    }
                    var vm = this;
                    if(!vm.phone) return $h.pushMsgOnce('请输入手机号码');
                    if(!$reg.isPhone(vm.phone)) return $h.pushMsgOnce('请输入正确的手机号码');
                    vm.goCode();
                }
            }
        });
    })


</script>
{/block}
