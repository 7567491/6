
{extend name="public/container"}
{block name="title"}错题回顾-{$Auth_site_name}{/block}
{block name="head"}
<style>
    body {
        padding-bottom: 1.46rem;
        background-color: #f5f5f5;
    }

    .swiper-container {
        margin-top: .3rem;
    }

    .swiper-slide > a {
        display: block;
        width: 5.4rem;
        height: .86rem;
        border-radius: .43rem;
        margin: .8rem auto;
        background-color: #2c8eff;
        font-size: .3rem;
        line-height: .86rem;
        text-align: center;
        color: #fff;
    }
</style>
{/block}
{block name="content"}
<div v-cloak id="app">
    <div class="question-detail-page">
        <div class="swiper-container">
            <div class="swiper-wrapper">
                <div class="swiper-slide">
                    <div class="type">{{ question.question_type | questionType }}</div>
                    <div class="status" :class="{ on: question.is_master }" @click="submitQuestion">{{ question.is_master ? '已掌握' : '未掌握' }}</div>
                    <div class="question">
                        <div>{{ question.stem }}</div>
                        <img v-if="question.image" :src="question.image" alt="">
                        <div :class="{ image: question.is_img }" class="label-group">
                            <label v-for="(option, index) in question.options" :key="option.key">
                                <input v-if="question.question_type === 2" v-model="question.user_answer" type="checkbox" :value="option.key" disabled hidden>
                                <input v-else v-model="question.user_answer" type="radio" :value="option.key" disabled hidden>
                                <div
                                  :class="{
                                      ok: option.right,
                                      no: !option.right && (option.key === question.user_answer || -1 !== question.user_answer.indexOf(option.key))
                                  }"
                                >{{ option.value }}</div>
                            </label>
                        </div>
                    </div>
                    <div class="analysis">
                        <div class="no">回答错误</div>
                        <div>
                            <div>正确答案：<div>{{ question.answer }}</div></div>
                            <div>您的答案：<div>{{ question.user_answer && question.user_answer.toString() }}</div></div>
                        </div>
                        <div>试题难度：<span v-for="star in 5" :key="star" :class="{ on: star <= question.difficulty }" class="iconfont iconxing"></span></div>
                        <div>答案解析：</div>
                        <div v-html="question.analysis"></div>
                        <div v-if="question.special && question.special.length">关联知识点：</div>
                        <a
                            v-for="special in question.special"
                            :key="special.id"
                            :href="(special.is_light ? '{:url('/m/single-course')}' : '{:url('/m/view-course')}') + '?id=' + special.id"
                        >{{ special.title }}</a>
                    </div>
                    <a href="javascript:" @click="submitQuestion">{{ question.is_master ? '我未掌握' : '我已掌握' }}</a>
                </div>
            </div>
        </div>
    </div>
{include file="public/store_menu"}
</div>
<script>
    require(['vue', 'helper', 'store', 'swiper', 'quick'], function (Vue, $h, $http, Swiper) {
        var vm = new Vue({
            el: '#app',
            filters: {
                questionType: function (value) {
                    switch (value) {
                        case 1:
                            return '单选题';
                            break;
                        case 2:
                            return '多选题';
                            break;
                        default:
                            return '判断题';
                            break;
                    }
                },
                formatTime: function (time) {
                    var hour = Math.floor(time / 3600000);
                    var minute = Math.floor((time - hour * 3600000) / 60000);
                    var second = Math.floor((time - hour * 3600000 - minute * 60000) / 1000);

                    if (hour < 10) {
                        hour = '0' + hour;
                    }
                    if (minute < 10) {
                        minute = '0' + minute;
                    }
                    if (second < 10) {
                        second = '0' + second;
                    }

                    return hour + ':' + minute + ':' + second;
                }
            },
            data: {
                question: {},
                id: '',
                is_master: 0
            },
            created: function () {
                this.id = $h.getParmas('id');
                this.is_master = parseInt($h.getParmas('is_master'));
                this.getQuestion();
            },
            methods: {
                getQuestion: function () {
                    $h.loadFFF();
                    $http.baseGet($h.U({
                        c: 'topic',
                        a: 'oneWrongBank',
                        q: {
                            id: this.id
                        }
                    }), function (res) {
                        $h.loadClear();

                        var question = res.data.data;
                        var option = JSON.parse(question.option);

                        question.options = [];

                        var answers = question.answer.split(',');

                        if (Array.isArray(option)) {
                            option.forEach(function (item, index) {
                                var right = false;

                                for (var j = answers.length; j--;) {
                                    if (answers[j] === String.fromCharCode(index + 65)) {
                                        right = true;
                                        break;
                                    }
                                }

                                question.options.push({
                                    right: right,
                                    key: String.fromCharCode(index + 65),
                                    value: item
                                });
                            });
                        } else {
                            for (var key in option) {
                                if (Object.hasOwnProperty.call(option, key)) {
                                    var right = false;

                                    for (var j = answers.length; j--;) {
                                        if (answers[j] === key) {
                                            right = true;
                                            break;
                                        }
                                    }

                                    question.options.push({
                                        right: right,
                                        key: key,
                                        value: option[key]
                                    });
                                }
                            }
                        }

                        if ('user_answer' in question) {
                            if (2 === question.question_type) {
                                question.user_answer = question.user_answer.split(',');
                            }
                        } else {
                            question.user_answer = 2 === question.question_type ? [] : '';
                        }

                        vm.question = question;
                    });
                },
                submitQuestion: function () {
                    $h.loadFFF();
                    $http.basePost($h.U({
                        c: 'topic',
                        a: 'submitWrongBank'
                    }), {
                        wrong_id: this.id,
                        questions_id: this.question.questions_id,
                        is_master: this.question.is_master ? 0 : 1
                    }, function (res) {
                        $h.loadClear();
                        vm.question.is_master = vm.question.is_master ? 0 : 1;
                    });
                }
            }
        });
    });
</script>
{/block}
