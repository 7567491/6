
{extend name="public/container"}
{block name="title"}{$storeInfo.store_name}-{$Auth_site_name}{/block}
{block name="head_top"}
<link rel="stylesheet" href="{$Think.const.IMG_DOMAIN}{__PLUG_PATH}vue-photo-preview/skin.css">
<script src="{$Think.const.IMG_DOMAIN}{__PLUG_PATH}vue-photo-preview/vue-photo-preview.js"></script>
<style>
    body {
        padding-bottom: 1rem;
    }

    .layui-layer-shade {
        opacity: 0.6 !important;
    }

    .layui-layer-imgsee {
        display: none;
    }
</style>
{/block}
{block name="content"}
<div v-cloak id="app">
    <div class="goods-detail">
        <div class="first">
            <div :style="{ height: sWidth + 'px' }" class="swiper-container">
                <div class="swiper-wrapper">
                    <div v-for="(item, index) in storeInfo.slider_image" :key="index" class="swiper-slide">
                        <img :src="item">
                    </div>
                </div>
                <div class="swiper-pagination"></div>
            </div>
            <div class="detail">
                <div class="price">
                    <div class="now">￥<span>{{ storeInfo.price }}</span></div>
                    <div class="vip">￥{{ storeInfo.vip_price }}</div>
                </div>
                <div class="title">{{ storeInfo.store_name }}</div>
                <div class="other">
                    <div>原价:￥{{ storeInfo.ot_price }}</div>
                    <div>库存:{{ storeInfo.stock }}件</div>
                    <div>销量:{{ storeInfo.sales }}件</div>
                </div>
            </div>
            <!-- 分享返佣 -->
            <rebate-guide v-if="rebateMoney" style="margin-top: 0" :rebate-money="rebateMoney" @rebate-action="rebateAction"></rebate-guide>
        </div>
        <div class="second">
            <div class="tab">
                <div :class="{ on: tabOn == 1 }" @click="tabOn = 1">详情</div>
                <div :class="{ on: tabOn == 2 }" @click="tabOn = 2">评价({{ whole }})</div>
                <div :class="{ on: tabOn == 3 }" @click="tabOn = 3">赠送课程({{ specialList.length }})</div>
            </div>
            <div class="content">
                <div v-show="tabOn == 1" class="detail" v-html="storeInfo.description"></div>
                <div v-show="tabOn == 2" class="evaluate-section">
                    <div class="head">
                        <div class="score">
                            <div>评分<span v-for="star in 5" :key="star" :class="{ on: star <= rate }" class="iconfont iconxing"></span></div>
                            <div>{{ positive_rate }}%<span>好评率</span></div>
                        </div>
                        <div class="cate">
                            <div :class="{ on: score === 4 }" @click="cateTab(4)">全部({{ whole }})</div>
                            <div :class="{ on: score === 3 }" @click="cateTab(3)">好评({{ praise }})</div>
                            <div :class="{ on: score === 2 }" @click="cateTab(2)">中评({{ review }})</div>
                            <div :class="{ on: score === 1 }" @click="cateTab(1)">差评({{ difference }})</div>
                        </div>
                    </div>
                    <!-- 评价列表 -->
                    <evaluate-list :evaluate-list="evaluateList"></evaluate-list>
                    <div v-if="loading" class="loading">
                        <i class="fa fa-spinner loadingpic"></i>
                    </div>
                    <div v-if="finished && evaluateList.length" class="finished">已全部加载完</div>
                    <div v-if="finished && !evaluateList.length" class="empty">
                        <img src="{$Think.const.IMG_DOMAIN}{__WAP_PATH}/images/empty.png" alt="暂无评价">
                        <div>暂无评价</div>
                    </div>
                </div>
                <div v-show="tabOn == 3" class="special">
                    <a v-for="item in specialList" :key="item.id" :href="item.path">
                        <div class="image">
                            <img :src="fx_cdn_img(item.image)">
                            <div>{{ item.typeName }}</div>
                        </div>
                        <div class="text">
                            <div class="title">{{ item.title }}</div>
                            <div class="label">
                                <div v-for="label in item.label">{{ label }}</div>
                            </div>
                            <div class="price">￥<span>{{ item.money }}</span></div>
                        </div>
                    </a>
                </div>
            </div>
        </div>
        <div class="third">
            <div class="group">
                <button type="button" @click="goPage(1)">
                    <img src="{$Think.const.IMG_DOMAIN}{__WAP_PATH}/images/detail-home.png">
                    <div>首页</div>
                </button>
                <button type="button" @click="goPage(2)">
                    <img src="{$Think.const.IMG_DOMAIN}{__WAP_PATH}/images/detail-chat.png">
                    <div>客服</div>
                </button>
            </div>
            <button type="button" @click="cardUp">立即购买</button>
        </div>
        <div class="share" @click="createSharePoster">
            <i class="iconfont iconfenxiang"></i>
        </div>
    </div>
    <base-login :login-show="loginShow" :site-name="siteName" @login-close="logComplete"></base-login>
</div>
<script>
    require([
        'vue',
        'store',
        'helper',
        'swiper',
        'components/evaluate-list/index',
        'components/base_login/index',
        'components/rebate-guide/index',
        'qrcode',
        '{$Think.const.IMG_DOMAIN}{__WAP_PATH}/js/quick.js'
    ], function (Vue, api, $h, Swiper, evaluateList, BaseLogin, RebateGuide) {
        var storeInfo = {$storeInfo};
        var siteUrl = '{$site_url}';
        var siteName = '{$Auth_site_name}';
        var isWechat = '{$isWechat}';
        var uid = {$uid};
        var options={
            captionEl: false,
            fullscreenEl: false,
            zoomEl: false,
            arrowEl: false
        };
        Vue.use(vuePhotoPreview, options);
        var app = new Vue({
            el: '#app',
            components: {
                'evaluate-list': evaluateList,
                'base-login': BaseLogin,
                'rebate-guide': RebateGuide
            },
            data: {
                storeInfo: storeInfo ? storeInfo : [],
                sWidth: window.innerWidth,
                loginShow: false,
                isWechat: isWechat,
                url: isWechat ? $h.U({c:'index',a:'login'}) : $h.U({c:'login',a:'phone_check'}),
                tabOn: 1,
                score: 4,
                page: 1,
                limit: 16,
                loading: false,
                finished: false,
                evaluateList: [],
                rate: 5,
                positive_rate: '0',
                whole: 0,
                praise: 0,
                review: 0,
                difference: 0,
                siteUrl: siteUrl,
                siteName: siteName,
                rebateMoney: 0,
                page2: 1,
                specialList: []
            },
            computed: {
                carouselHeight: function () {
                    return this.screenWidth;
                }
            },
            mounted: function () {
                var that=this;
                this.$nextTick(function () {
                    this.initCarousel();
                    this.initResize();
                    this.getEvaluateStatus();
                    this.getEvaluateList();
                    this.rebateAmount();
                    this.getAssociatedTopics();
                    mapleWx($jssdk(), function () {
                        this.onMenuShareAll({
                            title: that.storeInfo.store_name,
                            desc: that.storeInfo.store_info,
                            imgUrl: that.storeInfo.image,
                            link: location.href.indexOf('?') == -1 ? location.href + '?spread_uid=' + uid : location.href + '&spread_uid=' + uid,
                        });
                    });
                    $h.EventUtil.listenTouchDirection(document, function () {
                        if (app.tabOn === 2) {
                            app.getEvaluateList();
                        }
                    });
                });
            },
            updated: function () {
                this.$nextTick(function () {
                    this.$previewRefresh();
                });
            },
            methods: {
                goPage: function (value) {
                    switch (value) {
                        case 1:
                            window.location.assign("{$m_home_url}");
                            break;
                        case 2:
                            window.location.assign("{:url('/m/service')}");
                            break;
                    }
                },
                initCarousel: function () {
                    var carousel = new Swiper('.swiper-container', {
                        autoplay: true,
                        pagination: {
                            el: '.swiper-pagination'
                        },
                        loop: true,
                        observer: true,
                        observeParents: true
                    });
                    if (carousel.slides.length <= 3) {
                        carousel.destroy();
                    }
                },
                initResize: function () {
                    window.onresize = function () {
                        this.screenWidth = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
                    }.bind(this);
                },
                cardUp: function () {
                    api.baseGet($h.U({c:'index',a:'user_login'}),function (res) {
                        this.loginShow=false;
                        api.goBuy({
                            productId: this.storeInfo.id,
                            cartNum: 1
                        }, function (cartId) {
                            location.href = "{:url('wap/special/confirm_order')}?cartId="+cartId;
                        });
                    }.bind(this),function (res) {
                        this.loginShow=true;
                        return false;
                    }.bind(this));

                },
                enter: function () {
                    this.loginShow = true;
                },
                //关闭登录
                loginClose:function(value){
                    this.loginShow=false;
                    value && this.logComplete();
                },
                //登录完成回调事件
                logComplete:function(){
                    this.loginShow=false;
                },
                //所有插件回调处理事件
                changeVal: function (opt) {
                    if (typeof opt != 'object') opt = {};
                    var action = opt.action || '';
                    var value = opt.value || '';
                    this[action] && this[action](value);
                },
                // 获取评价列表
                getEvaluateList: function () {
                    if (this.loading || this.finished) {
                        return;
                    }
                    this.loading = true;
                    $h.loadFFF();
                    api.baseGet($h.U({
                        c: 'auth_api',
                        a: 'product_reply_list',
                        q: {
                            productId: this.storeInfo.id,
                            score: this.score,
                            page: this.page++,
                            limit: this.limit
                        }
                    }), function (res) {
                        app.loading = false;
                        $h.loadClear();
                        var resData = res.data;
                        if (resData.code === 200) {
                            var data = resData.data;
                            app.evaluateList = app.evaluateList.concat(data);
                            app.finished = app.limit > data.length;
                        } else {
                            $h.pushMsg(resData.msg);
                        }
                    }, function () {
                        app.loading = false;
                        $h.loadClear();
                    });
                },
                // 获取各状态评价数量
                getEvaluateStatus: function () {
                    api.baseGet($h.U({
                        c: 'auth_api',
                        a: 'product_reply_data',
                        q: {
                            productId: this.storeInfo.id
                        }
                    }), function (res) {
                        var resData = res.data;
                        if (resData.code === 200) {
                            var data = resData.data;
                            app.rate = data.star;
                            app.positive_rate = data.positive_rate;
                            app.whole = data.whole;
                            app.praise = data.praise;
                            app.review = data.review;
                            app.difference = data.difference;
                        } else {
                            $h.pushMsg(resData.msg);
                        }
                    })
                },
                // 评价列表状态切换
                cateTab: function (score) {
                    if (this.score === score) {
                        return;
                    }
                    this.score = score;
                    this.evaluateList = [];
                    this.loading = false;
                    this.finished = false;
                    this.page = 1;
                    this.getEvaluateList();
                },
                // 生成分享海报
                createSharePoster: function () {
                    var vm = this;
                    var imagePromise = new Promise(function (resolve, reject) {
                        var image = new Image();
                        image.crossOrigin = 'anonymous';
                        image.src = vm.storeInfo.image + '?' + new Date().getTime();
                        image.onload = function () {
                            resolve(image);
                        },
                        image.onerror = function () {
                            reject('error-image');
                        };
                    }),
                        qrcodePromise = new Promise(function (resolve, reject) {
                            resolve(new QRCode(document.createElement('canvas'), vm.siteUrl));
                        });
                    Promise.all([
                        imagePromise,
                        qrcodePromise
                    ]).then(function (sources) {
                        var canvas = document.createElement('canvas');
                        var context = canvas.getContext('2d');
                        canvas.width = 600;
                        canvas.height = 810;

                        context.fillStyle = '#FFFFFF';
                        context.fillRect(0, 0, 600, 810);

                        context.drawImage(sources[0], 0, 0, 600, 600);
                        context.drawImage(sources[1]._el.firstElementChild, 118, 630, 150, 150);

                        context.font = '22px sans-serif';
                        context.fillStyle = '#999999';
                        context.fillText('邀您加入' + vm.siteName, 284, 690);
                        context.fillText('长按识别或扫码进入', 284, 750);

                        layer.photos({
                            photos: {
                                data: [
                                    {
                                        src: canvas.toDataURL('image/jpeg')
                                    }
                                ]
                            },
                            anim: 5
                        });
                        canvas = null;
                    }).catch(function (err) {
                        $h.pushMsg(err);
                    });
                },
                // 获取返佣金额
                rebateAmount: function () {
                    var vm = this;
                    api.baseGet($h.U({
                        c: 'auth_api',
                        a: 'rebateAmount',
                        p: {
                            type: 2,
                            id: this.storeInfo.id
                        }
                    }), function (res) {
                        vm.rebateMoney = parseFloat(res.data.data.brokeragePrice);
                    });
                },
                rebateAction: function (value) {
                    switch (value) {
                        case 'close':
                            this.rebateMoney = 0;
                            break;
                        case 'share':
                            this.createSharePoster();
                            break;
                    }
                },
                // 获取关联课程
                getAssociatedTopics: function () {
                    var vm = this;
                    api.baseGet($h.U({
                        c: 'store',
                        a: 'getAssociatedTopics',
                        q: {
                            page: this.page2,
                            list: 100,
                            id: this.storeInfo.id
                        }
                    }), function (res) {
                        var data = res.data.data;
                        data.forEach(function (item) {
                            var path = "{:url('/m/view-course')}";
                            var typeName = '图文';
                            if (item.is_light) {
                                path = "{:url('/m/single-course')}";
                            }
                            if (item.type === 2 || item.light_type === 2) {
                                typeName = '音频';
                            } else if (item.type === 3 || item.light_type === 3) {
                                typeName = '视频';
                            } else if (item.type === 4) {
                                typeName = '直播';
                            } else if (item.type === 5) {
                                typeName = '套餐';
                            }
                            item.path = path + '?id=' + item.id;
                            item.typeName = typeName;
                        });
                        vm.specialList = data;
                    });
                }
            }
        });
    });
</script>
{/block}
